{% extends 'foodmaster/base.html' %}

{% block title %}Food Master - Restaurant Search{% endblock %}

{% block content %}
<div class="wireframe-section">
  <div class="split-content">
    <div class="main-content">
      <h3>Restaurants Near You</h3>
      
      <!-- Filter Chips (static example) -->
      <!-- <div class="filters">
        <div class="filter-chip">Italian</div>
        <div class="filter-chip">$$</div>
        <div class="filter-chip">4.5+ ‚òÖ</div>
        <div class="filter-chip">Under 2 miles</div>
        <div class="filter-chip">More Filters +</div>
      </div> -->
      
      <!-- Check if we have any restaurants to display -->
      {% if restaurants %}
        {% for restaurant in restaurants %}
        <a href="{% url 'restaurant_detail' restaurant.id %}?lat={{ lat }}&lng={{ lng }}" style="text-decoration: none; color: inherit;">
          <div class="restaurant-card">
            {% if restaurant.photo_url %}
              <img src="{{ restaurant.photo_url }}" alt="Restaurant Image" style="width: 170px; height:170px; object-fit: cover;">
            {% else %}
              <div class="restaurant-img">üçï</div>
            {% endif %}
            
            <div class="restaurant-info">
              <h3>{{ restaurant.name.text.text }}</h3>
              {% if restaurant.rating %}
                <div>
                  ‚≠ê {{ restaurant.rating }}
                  {% if restaurant.userRatingCount %}
                    ({{ restaurant.userRatingCount }} reviews)
                  {% endif %}
                </div>
              {% else %}
                <div>No rating</div>
              {% endif %}
              {% if restaurant.priceLevel %}
                <div>
                  Price Level:
                  {% if restaurant.priceLevel == "PRICE_LEVEL_INEXPENSIVE" %}
                    $
                  {% elif restaurant.priceLevel == "PRICE_LEVEL_MODERATE" %}
                    $$ 
                  {% elif restaurant.priceLevel == "PRICE_LEVEL_EXPENSIVE" %}
                    $$$ 
                  {% elif restaurant.priceLevel == "PRICE_LEVEL_VERY_EXPENSIVE" %}
                    $$$$
                  {% else %}
                    N/A
                  {% endif %}
                </div>
                
              {% endif %}
              <div>{{ restaurant.address }}</div>
              {% if restaurant.primaryTypeDisplayName %}
                <div>
                  <strong>Category:</strong> {{ restaurant.primaryTypeDisplayName }}
                </div>
              {% endif %}
            </div>
          </div>
        </a>
        {% endfor %}
      {% else %}
        <p>No restaurants found near your location.</p>
      {% endif %}
      
      {% comment %} <div style="text-align: center; margin-top: 20px;">
        <button class="btn btn-secondary">Load More Results</button>
      </div> {% endcomment %}
    </div>
    
    <!-- Sidebar with a placeholder map and filters -->
    <div class="sidebar">
      <div class="map-container" id="map" style="width: 100%; height: 400px;"></div>
      <script>
        function initMap() {
          // Get user's lat/lng from template context
          var userLat = parseFloat("{{ lat|default:'0' }}");
          var userLng = parseFloat("{{ lng|default:'0' }}");
      
          // Create map with a default center/zoom
          var map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: userLat, lng: userLng },
            zoom: 14
          });
      
          // Create a LatLngBounds object to auto-fit all markers
          var bounds = new google.maps.LatLngBounds();
          // Place a BLUE marker for the user's location (if valid)
          if (userLat !== 0 && userLng !== 0) {
            var userPos = { lat: userLat, lng: userLng };
            var userMarker = new google.maps.Marker({
              position: userPos,
              map: map,
              title: "You are here",
              icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
              }
            });
            bounds.extend(userPos);
          }
      
          // Loop over restaurants and create markers
          {% for r in restaurants %}
            {% if r.latitude and r.longitude %}
              (function() {
                var markerPos = {
                  lat: parseFloat("{{ r.latitude }}"),
                  lng: parseFloat("{{ r.longitude }}")
                };
      
                // Create the marker
                var marker = new google.maps.Marker({
                  position: markerPos,
                  map: map,
                  title: "{{ r.name.text.text|escapejs }}"
                });
      
                // Optional: an InfoWindow with details
                var infoContent = `
                  <div style="min-width: 200px;">
                    <strong>{{ r.name.text.text|escapejs }}</strong><br>
                    Rating: {{ r.rating }}<br>
                    Address: {{ r.address|escapejs }}
                  </div>
                `;
                var infowindow = new google.maps.InfoWindow({ content: infoContent });
                marker.addListener('click', function() {
                  infowindow.open(map, marker);
                });
      
                // Extend bounds so this marker is included in the viewport
                bounds.extend(markerPos);
              })();
            {% endif %}
          {% endfor %}
      
          // Fit the map to show all markers (user + restaurants)
          if (bounds.getNorthEast().equals(bounds.getSouthWest())) {
            // Means only have one marker or none
            map.setZoom(14);
            map.setCenter({ lat: userLat, lng: userLng });
          } else {
            // Otherwise, fit the bounds to include all markers
            map.fitBounds(bounds);
          }
        }
      </script>

      <!-- Load the Google Maps JavaScript API -->
      <script 
        src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap" 
        async 
        defer
      ></script>
      
      {% load static %}
      <link rel="stylesheet" href="{% static 'foodmaster/dashboard_style.css' %}">
      <div class="filter-container">
        <h4 class="filter-title">Restaurant Filters</h4>
        <form method="get" action="{% url 'restaurant_search' %}">
          <!-- Store the location variable -->
          {% if lat and lng %}
            <input type="hidden" name="lat" value="{{ lat }}">
            <input type="hidden" name="lng" value="{{ lng }}">
          {% endif %}
        
        <!-- Cuisine -->
        <div class="form-group">
          <label class="form-label">Cuisine</label>
          <select name="cuisine" class="form-input">
            <option value="">All Cuisines</option>
            <option value="italian" {% if request.GET.cuisine == "italian" %}selected{% endif %}>Italian</option>
            <option value="chinese" {% if request.GET.cuisine == "chinese" %}selected{% endif %}>Chinese</option>
            <option value="japanese" {% if request.GET.cuisine == "japanese" %}selected{% endif %}>Japanese</option>
            <option value="mexican" {% if request.GET.cuisine == "mexican" %}selected{% endif %}>Mexican</option>
          </select>
        </div>
      
        <!-- Price Range -->
        <div class="form-group">
          <label class="form-label">Price Range</label>
          <select name="price" class="form-input">
            <option value="">Any</option>
            <option value="1" {% if request.GET.price == "1" %}selected{% endif %}>$</option>
            <option value="2" {% if request.GET.price == "2" %}selected{% endif %}>$$</option>
            <option value="3" {% if request.GET.price == "3" %}selected{% endif %}>$$$</option>
            <option value="4" {% if request.GET.price == "4" %}selected{% endif %}>$$$$</option>
          </select>
        </div>
      
        <!-- Distance -->
        <div class="form-group">
          <label class="form-label">Distance</label>
          <select name="distance" class="form-input">
            <option value="">Any</option>
            <option value="1" {% if request.GET.distance == "1" %}selected{% endif %}>Under 1 mile</option>
            <option value="2" {% if request.GET.distance == "2" %}selected{% endif %}>Under 2 miles</option>
            <option value="5" {% if request.GET.distance == "5" %}selected{% endif %}>Under 5 miles</option>
          </select>
        </div>
      
        <!-- Rating -->
        <div class="form-group">
          <label class="form-label">Rating</label>
          <select name="rating" class="form-input">
            <option value="">Any</option>
            <option value="3" {% if request.GET.rating == "3" %}selected{% endif %}>3+ stars</option>
            <option value="4" {% if request.GET.rating == "4" %}selected{% endif %}>4+ stars</option>
            <option value="4.5" {% if request.GET.rating == "4.5" %}selected{% endif %}>4.5+ stars</option>
          </select>
        </div>
      
        <button type="submit" class="btn btn-primary filter-button">Apply Filters</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript: prompt for location if not present in URL -->
<script>
  document.addEventListener('DOMContentLoaded', function(){
      // Get URL parameters
      let urlParams = new URLSearchParams(window.location.search);
      let urlLat = urlParams.get('lat');
      let urlLng = urlParams.get('lng');
      
      // Get stored location from sessionStorage
      let storedLat = sessionStorage.getItem('lat');
      let storedLng = sessionStorage.getItem('lng');
      
      if(urlLat && urlLng){
          // If URL has lat/lng, store them in sessionStorage
          sessionStorage.setItem('lat', urlLat);
          sessionStorage.setItem('lng', urlLng);
      } else if(storedLat && storedLng){
          // If sessionStorage has lat/lng, set them in URL
          urlParams.set("lat", storedLat);
          urlParams.set("lng", storedLng);
          // Use replaceState to avoid adding a new entry in the browser history
          window.history.replaceState({}, "", window.location.pathname + "?" + urlParams.toString());
          return;
      } else {
          // If no lat/lng in URL or sessionStorage, prompt for location
          if (confirm("Allow location access to show restaurants near you?")) {
              if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(success, error);
              } else {
                  alert("Geolocation is not supported by this browser.");
              }
          }
      }
      
      function success(position) {
          var latitude = position.coords.latitude;
          var longitude = position.coords.longitude;
          // Save lat/lng to sessionStorage
          sessionStorage.setItem('lat', latitude);
          sessionStorage.setItem('lng', longitude);
          let currentParams = new URLSearchParams(window.location.search);
          currentParams.set("lat", latitude);
          currentParams.set("lng", longitude);
          window.location.href = window.location.pathname + "?" + currentParams.toString();
      }
      
      function error(err) {
          console.warn("ERROR(" + err.code + "): " + err.message);
      }
  });
</script>

{% endblock %}