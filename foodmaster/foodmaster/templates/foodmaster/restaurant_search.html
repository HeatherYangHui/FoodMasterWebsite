{% extends 'foodmaster/base.html' %}

{% block title %}Food Master - Restaurant Search{% endblock %}

{% block content %}
<div class="wireframe-section">
  <div class="wireframe">
    <!-- Navbar -->
    <div class="navbar">
      <div class="logo">Food Master</div>
      <div class="search-bar">Search for restaurants...</div>
      <div class="nav-menu">
        <div class="nav-link">Home</div>
        <div class="nav-link active">Discover</div>
        <div class="nav-link">Cook&Home</div>
        <div class="nav-link">Social</div>
        <div class="nav-link">Saved</div>
      </div>
      <div class="user-menu">
        <div class="user-avatar">üë§</div>
      </div>
    </div>
    
    <div class="split-content">
      <div class="main-content">
        <h3>Restaurants Near You</h3>
        
        <!-- Filter Chips (static example) -->
        <div class="filters">
          <div class="filter-chip">Italian</div>
          <div class="filter-chip">$$</div>
          <div class="filter-chip">4.5+ ‚òÖ</div>
          <div class="filter-chip">Under 2 miles</div>
          <div class="filter-chip">More Filters +</div>
        </div>
        
        <!-- Check if we have any restaurants to display -->
        {% if restaurants %}
          {% for restaurant in restaurants %}
          <div class="restaurant-card">
            {% if restaurant.photo_url %}
              <img src="{{ restaurant.photo_url }}" alt="Restaurant Image" style="width: 135px; height:135px; object-fit: cover;">
            {% else %}
              <div class="restaurant-img">üçï</div>
            {% endif %}
            
            <div class="restaurant-info">
              <h4>{{ restaurant.name.text.text }}</h4>
              {% if restaurant.rating %}
                <div>
                  ‚≠ê {{ restaurant.rating }}
                  {% if restaurant.userRatingCount %}
                    ({{ restaurant.userRatingCount }} reviews)
                  {% endif %}
                </div>
              {% else %}
                <div>No rating</div>
              {% endif %}
              {% if restaurant.priceLevel %}
                <div>
                  Price Level: 
                  {% for i in "x"|slice:restaurant.priceLevel %}
                    $
                  {% endfor %}
                </div>
              {% endif %}
              <div>{{ restaurant.address }}</div>
              {% if restaurant.types %}
                <div>
                  <strong>Category:</strong>
                  {% for t in restaurant.types %}
                    {{ t }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p>No restaurants found near your location.</p>
        {% endif %}
        
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn btn-secondary">Load More Results</button>
        </div>
      </div>
      
      <!-- Sidebar with a placeholder map and filters -->
      <div class="sidebar">
        <div class="map-container">
          [Map View]
        </div>
        
        <div style="background-color: #f9f9f9; border-radius: 8px; padding: 15px;">
          <h4>Filter Results</h4>
          
          <form method="get" action="{% url 'restaurant_search' %}">
            <div class="form-group">
              <label class="form-label">Cuisine</label>
              <select name="cuisine" class="form-input">
                <option value="">All Cuisines</option>
                <option value="italian" selected>Italian</option>
                <option value="chinese">Chinese</option>
                <option value="japanese">Japanese</option>
                <option value="mexican">Mexican</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Price Range</label>
              <select name="price" class="form-input">
                <option value="">Any</option>
                <option value="1">$</option>
                <option value="2" selected>$$</option>
                <option value="3">$$$</option>
                <option value="4">$$$$</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Distance</label>
              <select name="distance" class="form-input">
                <option value="">Any</option>
                <option value="1">Under 1 mile</option>
                <option value="2" selected>Under 2 miles</option>
                <option value="5">Under 5 miles</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Rating</label>
              <select name="rating" class="form-input">
                <option value="">Any</option>
                <option value="3">3+ stars</option>
                <option value="4">4+ stars</option>
                <option value="4.5" selected>4.5+ stars</option>
              </select>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">Apply Filters</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript: prompt for location if not present in URL -->
<script>
  document.addEventListener('DOMContentLoaded', function(){
      // Parse query parameters to see if lat and lng already exist.
      const urlParams = new URLSearchParams(window.location.search);
      const hasLat = urlParams.has('lat');
      const hasLng = urlParams.has('lng');
  
      // Only prompt if the URL does not already include lat and lng.
      if (!hasLat || !hasLng) {
          if (confirm("Allow location access to show restaurants near you?")) {
              if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(success, error);
              } else {
                  alert("Geolocation is not supported by this browser.");
              }
          }
      }
  
      function success(position) {
          var latitude = position.coords.latitude;
          var longitude = position.coords.longitude;
          // Reload the page with the coordinates as query parameters.
          window.location.href = window.location.pathname + "?lat=" + latitude + "&lng=" + longitude;
      }
      
      function error(err) {
          console.warn("ERROR(" + err.code + "): " + err.message);
          // Optionally display an error message or fallback behavior.
      }
  });
</script>
{% endblock %}
