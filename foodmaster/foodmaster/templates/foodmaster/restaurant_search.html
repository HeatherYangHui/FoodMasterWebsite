{% extends 'foodmaster/base.html' %}

{% block title %}Food Master - Restaurant Search{% endblock %}

{% block content %}
<div class="wireframe-section">
  <div class="split-content">
    <div class="main-content">
      <h3>Restaurants Near You</h3>
      
      <!-- Filter Chips (static example) -->
      <!-- <div class="filters">
        <div class="filter-chip">Italian</div>
        <div class="filter-chip">$$</div>
        <div class="filter-chip">4.5+ ★</div>
        <div class="filter-chip">Under 2 miles</div>
        <div class="filter-chip">More Filters +</div>
      </div> -->
      
      <!-- Check if we have any restaurants to display -->
      {% if restaurants %}
        {% for restaurant in restaurants %}
        <div class="restaurant-card">
          {% if restaurant.photo_url %}
            <img src="{{ restaurant.photo_url }}" alt="Restaurant Image" style="width: 135px; height:135px; object-fit: cover;">
          {% else %}
            <div class="restaurant-img">🍕</div>
          {% endif %}
          
          <div class="restaurant-info">
            <h4>{{ restaurant.name.text.text }}</h4>
            {% if restaurant.rating %}
              <div>
                ⭐ {{ restaurant.rating }}
                {% if restaurant.userRatingCount %}
                  ({{ restaurant.userRatingCount }} reviews)
                {% endif %}
              </div>
            {% else %}
              <div>No rating</div>
            {% endif %}
            {% if restaurant.priceLevel %}
              <!-- <div>
                Price Level: 
                {% for i in "x"|slice:restaurant.priceLevel %}
                  $
                {% endfor %}
              </div> -->
              <div>
                Price Level:
                {% if restaurant.priceLevel == "PRICE_LEVEL_INEXPENSIVE" %}
                  $
                {% elif restaurant.priceLevel == "PRICE_LEVEL_MODERATE" %}
                  $$ 
                {% elif restaurant.priceLevel == "PRICE_LEVEL_EXPENSIVE" %}
                  $$$ 
                {% elif restaurant.priceLevel == "PRICE_LEVEL_VERY_EXPENSIVE" %}
                  $$$$
                {% else %}
                  N/A
                {% endif %}
              </div>
              
            {% endif %}
            <div>{{ restaurant.address }}</div>
            {% if restaurant.types %}
              <div>
                <strong>Category:</strong>
                {% for t in restaurant.types %}
                  {{ t }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p>No restaurants found near your location.</p>
      {% endif %}
      
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn btn-secondary">Load More Results</button>
      </div>
    </div>
    
    <!-- Sidebar with a placeholder map and filters -->
    <div class="sidebar">
      <div class="map-container">
        [Map View]
      </div>
      
      <div style="background-color: #f9f9f9; border-radius: 8px; padding: 15px;">
        <h4>Filter Results</h4>
        
        <form method="get" action="{% url 'restaurant_search' %}">
          <!-- 保留定位参数 -->
          {% if lat and lng %}
            <input type="hidden" name="lat" value="{{ lat }}">
            <input type="hidden" name="lng" value="{{ lng }}">
          {% endif %}
          
          <div class="form-group">
            <label class="form-label">Cuisine</label>
            <select name="cuisine" class="form-input">
              <option value="">All Cuisines</option>
              <option value="italian" {% if request.GET.cuisine == "italian" %}selected{% endif %}>Italian</option>
              <option value="chinese" {% if request.GET.cuisine == "chinese" %}selected{% endif %}>Chinese</option>
              <option value="japanese" {% if request.GET.cuisine == "japanese" %}selected{% endif %}>Japanese</option>
              <option value="mexican" {% if request.GET.cuisine == "mexican" %}selected{% endif %}>Mexican</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Price Range</label>
            <select name="price" class="form-input">
              <option value="">Any</option>
              <option value="1" {% if request.GET.price == "1" %}selected{% endif %}>$</option>
              <option value="2" {% if request.GET.price == "2" %}selected{% endif %}>$$</option>
              <option value="3" {% if request.GET.price == "3" %}selected{% endif %}>$$$</option>
              <option value="4" {% if request.GET.price == "4" %}selected{% endif %}>$$$$</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Distance</label>
            <select name="distance" class="form-input">
              <option value="">Any</option>
              <option value="1" {% if request.GET.distance == "1" %}selected{% endif %}>Under 1 mile</option>
              <option value="2" {% if request.GET.distance == "2" %}selected{% endif %}>Under 2 miles</option>
              <option value="5" {% if request.GET.distance == "5" %}selected{% endif %}>Under 5 miles</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Rating</label>
            <select name="rating" class="form-input">
              <option value="">Any</option>
              <option value="3" {% if request.GET.rating == "3" %}selected{% endif %}>3+ stars</option>
              <option value="4" {% if request.GET.rating == "4" %}selected{% endif %}>4+ stars</option>
              <option value="4.5" {% if request.GET.rating == "4.5" %}selected{% endif %}>4.5+ stars</option>
            </select>
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%;">Apply Filters</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript: prompt for location if not present in URL -->
<script>
  document.addEventListener('DOMContentLoaded', function(){
      // 获取 URL 参数中的 lat 和 lng
      let urlParams = new URLSearchParams(window.location.search);
      let urlLat = urlParams.get('lat');
      let urlLng = urlParams.get('lng');
      
      // 从 sessionStorage 中读取定位信息
      let storedLat = sessionStorage.getItem('lat');
      let storedLng = sessionStorage.getItem('lng');
      
      if(urlLat && urlLng){
          // 如果 URL 中已有定位信息，则更新 sessionStorage
          sessionStorage.setItem('lat', urlLat);
          sessionStorage.setItem('lng', urlLng);
      } else if(storedLat && storedLng){
          // 如果 URL 中没有，但 sessionStorage 有，则更新 URL（不提示）
          urlParams.set("lat", storedLat);
          urlParams.set("lng", storedLng);
          // 使用 replaceState 避免重复创建历史记录
          window.history.replaceState({}, "", window.location.pathname + "?" + urlParams.toString());
          return;
      } else {
          // 如果既没有 URL 也没有 sessionStorage，则提示获取定位
          if (confirm("Allow location access to show restaurants near you?")) {
              if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(success, error);
              } else {
                  alert("Geolocation is not supported by this browser.");
              }
          }
      }
      
      function success(position) {
          var latitude = position.coords.latitude;
          var longitude = position.coords.longitude;
          // 将获取的定位信息保存到 sessionStorage 中
          sessionStorage.setItem('lat', latitude);
          sessionStorage.setItem('lng', longitude);
          let currentParams = new URLSearchParams(window.location.search);
          currentParams.set("lat", latitude);
          currentParams.set("lng", longitude);
          window.location.href = window.location.pathname + "?" + currentParams.toString();
      }
      
      function error(err) {
          console.warn("ERROR(" + err.code + "): " + err.message);
      }
  });
</script>

{% endblock %}