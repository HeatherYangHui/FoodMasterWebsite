{% extends 'foodmaster/base.html' %}
{% block title %}Saved Items{% endblock %}
{% block content %}
<div class="wireframe-section">
  <h2>Saved Restaurants</h2>
  {% if saved_restaurants %}
  <div style="display: flex; flex-direction: column; gap: 16px;">
    {% for saved in saved_restaurants %}
      <!-- Make this container flex, so text (left) & photo (right) appear side by side -->
      <div style="border: 1px solid #eee; border-radius: 8px; padding: 12px; 
                  display: flex; align-items: center; justify-content: space-between;">
        
        <!-- Text block on the left -->
        <div style="flex: 1; margin-right: 16px;">
          <h3>{{ saved.name }}</h3>
          <p>{{ saved.address }}</p>
          <a href="{% url 'restaurant_detail' saved.place_id %}" class="btn btn-primary">
            View Restaurant
          </a>
        </div>
        
        <!-- Photo block on the right -->
        <div style="flex-shrink: 0;">
          {% if saved.photo_url %}
            <img src="{{ saved.photo_url }}" alt="{{ saved.name }}" 
                 style="width:80px; height:80px; object-fit:cover; border-radius:4px;">
          {% else %}
            <div style="width:80px; height:80px; background-color:#ccc; 
                        border-radius:4px; display:flex; align-items:center; 
                        justify-content:center;">
              <span style="color:#fff;">No Photo</span>
            </div>
          {% endif %}
        </div>
        
      </div>
    {% endfor %}
  </div>
  {% else %}
    <p>You have not saved any restaurants yet.</p>
  {% endif %}
  
  <h2 style="margin-top: 40px;">Saved Recipes</h2>
  {% if saved_recipes %}
    <div style="display: flex; flex-direction: column; gap: 16px;">
      {% for saved in saved_recipes %}
        <div style="border: 1px solid #eee; border-radius: 8px; padding: 12px;">
          <h3>{{ saved.title }}</h3>
          <p>Saved on {{ saved.saved_at|date:"M d, Y" }}</p>
          <a href="{% url 'recipe_detail' %}?dish={{ saved.title }}" class="btn btn-primary">View Recipe</a>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>You have not saved any recipes yet.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    // Step 1: Retrieve lat/lng from URL or sessionStorage
    let urlParams = new URLSearchParams(window.location.search);
    let urlLat = urlParams.get('lat');
    let urlLng = urlParams.get('lng');
    
    let storedLat = sessionStorage.getItem('lat');
    let storedLng = sessionStorage.getItem('lng');
    
    if (urlLat && urlLng && urlLat !== "" && urlLng !== "") {
        // If URL has valid lat/lng, store them in sessionStorage
        sessionStorage.setItem('lat', urlLat);
        sessionStorage.setItem('lng', urlLng);
    } else if (storedLat && storedLng) {
        // If URL is missing lat/lng but sessionStorage has them, update the URL
        urlParams.set("lat", storedLat);
        urlParams.set("lng", storedLng);
        window.history.replaceState({}, "", window.location.pathname + "?" + urlParams.toString());
    } else {
        // Step 2: If we have no lat/lng at all, prompt the user for geolocation
        if (confirm("Allow location access to retrieve your position?")) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(success, error);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
    }

    function success(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        // Store them
        sessionStorage.setItem('lat', latitude);
        sessionStorage.setItem('lng', longitude);
        
        // Also update the URL without reloading
        let currentParams = new URLSearchParams(window.location.search);
        currentParams.set("lat", latitude);
        currentParams.set("lng", longitude);
        window.history.replaceState({}, "", window.location.pathname + "?" + currentParams.toString());
        
        // Now that we have lat/lng, let's rewrite the “View” links
        updateSavedLinks(latitude, longitude);
    }

    function error(err) {
        console.warn("ERROR(" + err.code + "): " + err.message);
    }

    function updateSavedLinks(lat, lng) {
        // For each “View Restaurant” or “View Recipe” link with class="btn btn-primary"
        document.querySelectorAll('.btn.btn-primary').forEach(link => {
            let linkUrl = new URL(link.href);
            linkUrl.searchParams.set("lat", lat);
            linkUrl.searchParams.set("lng", lng);
            link.href = linkUrl.toString();
        });
    }

    // If we already had lat/lng in sessionStorage at page load, rewrite links now
    if (sessionStorage.getItem('lat') && sessionStorage.getItem('lng')) {
        updateSavedLinks(sessionStorage.getItem('lat'), sessionStorage.getItem('lng'));
    }
});
</script>
{% endblock %}