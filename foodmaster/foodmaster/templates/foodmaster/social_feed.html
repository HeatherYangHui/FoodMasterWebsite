{% extends 'foodmaster/base.html' %}

{% block title %}Food Master - Social Feed{% endblock %}

{% block content %}
<div class="wireframe-section">

    <div class="split-content">
      <div class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3>Food Community</h3>
          <a href="{% url 'create_post' %}"><button class="btn btn-primary">Create Post</button></a>
        </div>
        
        <div class="filters">
          <div class="filter-chip">Following</div>
          <div class="filter-chip">Trending</div>
          <div class="filter-chip">Breakfast</div>
          <div class="filter-chip">Lunch</div>
          <div class="filter-chip">Dinner</div>
          <div class="filter-chip">Dessert</div>
        </div>
        
        <div class="social-feed">
          {% if posts %}
            {% for post in posts %}
            <div class="post" id="post-{{ post.id }}" data-post-id="{{ post.id }}">
              <div class="post-header">
                <div class="post-avatar">üë§</div>
                <div style="flex: 1;">
                  <div style="font-weight: bold;">{{ post.author }}</div>
                  <div style="font-size: 12px; color: #666;">{{ post.time_ago }} ‚Ä¢ {{ post.category }}</div>
                </div>
                {% if request.user != post.author %}
                  <button class="btn btn-secondary btn-sm follow-btn" data-profile-id="{{ post.author.profile.id }}" onclick="toggleFollow(this)">
                    {% if request.user in post.author.profile.followers.all %}
                      Unfollow
                    {% else %}
                      Follow
                    {% endif %}
                  </button>
                {% endif %}
              </div>
              <div class="post-image">
                {% if post.photo %}
                  <img src="{{ post.photo.url }}" loading="lazy" alt="Post Photo" style="max-width: 100%; height: 100%;">
                {% else %}
                  [Food Photo]
                {% endif %}
              </div>
              <div style="padding: 15px;">
                <p>{{ post.content }}</p>
                <div style="font-size: 12px; color: #4CAF50; margin-top: 10px;">
                  {% for tag in post.tags %}
                  <span>{{ tag }}</span>{% if not forloop.last %} ‚Ä¢ {% endif %}
                  {% endfor %}
                </div>
              </div>
              <div class="post-actions">
                <button class="like-btn" data-post-id="{{ post.id }}" onclick="toggleLike(this)">
                  {% if request.user in post.likes.all %}
                    ‚ù§Ô∏è
                  {% else %}
                    ü§ç
                  {% endif %}
                </button>
                <span class="like-count">{{ post.total_likes }} Likes</span>
                <span class="comment-count">{{ post.comments.count }} üí¨Comments</span>
                <div>üîó Share</div>
                {% if post.author == request.user %}
                    <button onclick="deletePost(this)" class="btn btn-danger btn-sm" style="float: right;">üóëÔ∏è Delete</button>
                {% endif %}
              </div>
              <button class="toggle-comments-btn" onclick="toggleComments(this)"> Show Comments</button>
              <!-- comment list -->
              <div class="comments" data-post-id="{{ post.id }}" style="margin-top: 15px; display: none;">
                {% for comment in post.comments.all %}
                  <div class="comment" style="margin-bottom: 10px;">
                    <strong>{{ comment.author.username }}</strong>: {{ comment.content }}
                    <br>
                    <small style="color: #666;">{{ comment.created_at|date:'M d, Y H:i' }}</small>
                  </div>
                {% empty %}
                  <div>No comments yet.</div>
                {% endfor %}
              </div>

              <!-- submit commet use ajax -->
              <form class="comment-form" data-post-id="{{ post.id }}" onsubmit="addComment(event, this)" style="margin-top: 10px;">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Add a comment..." style="width: 80%;">
                <button type="submit" class="btn btn-secondary" style="padding: 6px 12px;">Comment</button>
              </form>
            </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <div class="sidebar">
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; margin-bottom: 20px;">
          <h4>Your Profile</h4>
          <div style="display: flex; margin-bottom: 15px;">
            <div style="width: 60px; height: 60px; border-radius: 50%; background-color: #f0f0f0; margin-right: 15px; display: flex; align-items: center; justify-content: center;">üë§</div>
            <div>
              <div style="font-weight: bold;">{{ user.username }}</div>
              <div style="font-size: 14px; color: #666;">@{{ user.username }}</div>
              <div style="font-size: 14px; margin-top: 5px;">{{ user.bio|default:"Food enthusiast & home cook" }}</div>
            </div>
          </div>
          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div>
              <div style="font-weight: bold;">{{ user.post_set.count }}</div>
              <div style="font-size: 12px; color: #666;">Posts</div>
            </div>
            <div>
              <div style="font-weight: bold;">{{ user.profile.followers.count }}</div>
              <div style="font-size: 12px; color: #666;">Followers</div>
            </div>
            <div>
              <div style="font-weight: bold;">{{ user.following_profiles.count }}</div>
              <div style="font-size: 12px; color: #666;">Following</div>
            </div>
          </div>
          <a href="{% url 'profile' %}"><button class="btn btn-secondary" style="width: 100%;">Edit Profile</button></a>
        </div>
        
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; margin-bottom: 20px;">
          <h4>Trending Topics</h4>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
            <div class="filter-chip">#ItalianFood</div>
            <div class="filter-chip">#HomeCooking</div>
            <div class="filter-chip">#Desserts</div>
            <div class="filter-chip">#HealthyEating</div>
            <div class="filter-chip">#Breakfast</div>
            <div class="filter-chip">#FoodPhotography</div>
          </div>
        </div>
        
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px;">
          <h4>Suggested Users</h4>
          {% if suggested_users %}
            {% for suggested in suggested_users %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="display: flex; align-items: center;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #f0f0f0; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                  {% if suggested.profile_image %}
                    <img src="{{ suggested.profile_image.url }}" alt="Profile Image" style="width: 100%; height: 100%; border-radius: 50%;">
                  {% else %}
                    üë§
                  {% endif %}
                </div>
                <div>
                  <div style="font-weight: bold;">{{ suggested.user.username }}</div>
                  <div style="font-size: 12px; color: #666;">@{{ suggested.user.username }}</div>
                </div>
              </div>
              <button class="btn btn-secondary follow-btn" data-profile-id="{{ suggested.id }}" onclick="toggleFollow(this)">
                {% if request.user in suggested.followers.all %}
                  Unfollow
                {% else %}
                  Follow
                {% endif %}
              </button>
            </div>
            {% endfor %}
          {% else %}
            <div>No suggested users available.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>



<!-- JavaScript for AJAX operations -->
<script>
  const csrftoken = "{{ csrf_token }}";
  
  function toggleLike(buttonElement) {
    const postId = buttonElement.dataset.postId;
    fetch(`/ajax/like/${postId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        buttonElement.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
        const likeCountSpan = buttonElement.parentElement.querySelector('.like-count');
        likeCountSpan.textContent = data.likes_count + ' Likes';
      } else {
        alert('Error toggling like: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }
  
  function addComment(event, formElement) {
    event.preventDefault();
    const postId = formElement.dataset.postId;
    const contentInput = formElement.querySelector('input[name="content"]');
    const contentValue = contentInput.value;
    
    fetch(`/ajax/comment/${postId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({ 'content': contentValue })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        contentInput.value = '';
        const parent = formElement.parentElement;
        const commentCountSpan = parent.querySelector('.comment-count');
        commentCountSpan.textContent = data.comments_count + ' Comments';
        const commentsContainer = parent.querySelector('.comments');
        const newCommentDiv = document.createElement('div');
        newCommentDiv.classList.add('comment');
        newCommentDiv.style.marginBottom = '10px';
        newCommentDiv.innerHTML = `<strong>${data.author}</strong>: ${data.content}`;
        commentsContainer.appendChild(newCommentDiv);
      } else {
        alert('Error adding comment: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function toggleComments(button) {
    const postElement = button.closest('.post');
    const commentsSection = postElement.querySelector('.comments');
    if (commentsSection.style.display === 'none') {
      commentsSection.style.display = 'block';
      button.textContent = 'üí¨ Hide Comments';
    } else {
      commentsSection.style.display = 'none';
      button.textContent = 'üí¨ Show Comments';
    }
  }
  
  function deletePost(buttonElement) {
  if (!confirm("Are you sure you want to delete this post?")) return;
  const postElement = buttonElement.closest('.post');
  const postId = postElement.dataset.postId;

  fetch(`/posts/${postId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      postElement.remove();
    } else {
      alert(data.error || 'Delete failed.');
    }
  });
}

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function toggleFollow(buttonElement) {
    const profileId = buttonElement.dataset.profileId;
    fetch(`/ajax/follow/${profileId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        buttonElement.textContent = data.is_following ? 'Unfollow' : 'Follow';
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }

</script>
{% endblock %}
