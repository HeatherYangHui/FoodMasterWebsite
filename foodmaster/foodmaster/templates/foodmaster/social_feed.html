
{% extends 'foodmaster/base.html' %}
{% load single_timesince %}
{% block title %}Food Master - Social Feed{% endblock %}

{% block content %}


<div class="wireframe-section">

    <div class="split-content">
      <div class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h1>Food Community</h1>
          <a href="{% url 'create_post' %}"><button class="btn btn-primary">Create Post</button></a>
        </div>

        <div class="filters" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
          <a href="?filter=all" class="filter-chip {% if request.GET.filter == 'all' or not request.GET.filter %}active{% endif %}">All</a>
          <a href="?filter=following" class="filter-chip {% if request.GET.filter == 'following' %}active{% endif %}">Following</a>
          <a href="?filter=trending" class="filter-chip {% if request.GET.filter == 'trending' %}active{% endif %}">Trending</a>
          <a href="?filter=breakfast" class="filter-chip {% if request.GET.filter == 'breakfast' %}active{% endif %}">Breakfast</a>
          <a href="?filter=lunch" class="filter-chip {% if request.GET.filter == 'lunch' %}active{% endif %}">Lunch</a>
          <a href="?filter=dinner" class="filter-chip {% if request.GET.filter == 'dinner' %}active{% endif %}">Dinner</a>
          <a href="?filter=dessert" class="filter-chip {% if request.GET.filter == 'dessert' %}active{% endif %}">Dessert</a>

        </div>
        
        
        
        <div class="social-feed">
          {% if posts %}
            {% for post in posts %}
            <div class="post" id="post-{{ post.id }}" data-post-id="{{ post.id }}" style="background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; overflow: hidden; transition: transform 0.2s; border: 1px solid #f0f0f0;">
              <div class="post-header" style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #f5f5f5;">
                <div class="post-avatar" style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; margin-right: 12px;">
                  {% if post.author.profile.profile_image %}
                    <img src="{{ post.author.profile.profile_image.url }}" alt="Profile Image" style="width: 100%; height: 100%; object-fit: cover;">
                  {% else %}
                    üë§
                  {% endif %}
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 16px; color: #333;">{{ post.author }}</div>
                  <div style="margin-top: 3px; font-size: 14px; color: #666;">{{ post.created_at|single_timesince }} ‚Ä¢ {{ post.category }}</div>
                </div>
                {% if request.user != post.author %}
                  {% if request.user in post.author.profile.followers.all %}
                    <button class="follow-btn following" data-profile-id="{{ post.author.profile.id }}" onclick="toggleFollow(this)" 
                      style="background-color: #f0f0f0; color: #333; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                      Unfollow
                    </button>
                  {% else %}
                    <button class="follow-btn" data-profile-id="{{ post.author.profile.id }}" onclick="toggleFollow(this)" 
                      style="background-color: #4CAF50; color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                      Follow
                    </button>
                  {% endif %}
                {% endif %}
              </div>
              
              {% if post.postimage_set.all %}
                <div class="image-slider" style="position: relative;">
                  <div class="slider-wrapper" style="display: flex;">
                    {% for img in post.postimage_set.all %}
                      <img src="{{ img.image.url }}" loading="lazy"
                          alt="Post Photo"
                          style="width: 100%; flex-shrink: 0; transition: transform 0.3s;"
                          class="slider-image">
                    {% endfor %}
                  </div>

                  {% if post.postimage_set.all|length > 1 %}
                    <button class="slider-prev">‚óÄ</button>
                    <button class="slider-next">‚ñ∂</button>
                  {% endif %}
                </div>
                {% elif post.photo %}
                <div class="post-image-container">
                  <img src="{{ post.photo.url }}" loading="lazy" alt="Post Photo">
                </div>
                {% endif %}
                              
              <div style="padding: 20px;">
                <p style="font-size: 16px; line-height: 1.5; color: #333; margin: 0;">{{ post.content }}</p>
                {% if post.tags %}
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px;">
                  {% for tag in post.tags %}
                  <span style="background-color: #f0fff0; color: #4CAF50; border-radius: 4px; padding: 4px 8px; font-size: 13px; font-weight: 500;">#{{ tag }}</span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              {% if post.shared_from %}
                <div class="shared-info" style="background-color: #f9f9f9; border: 1px dashed #ccc; padding: 10px; margin: 10px 20px; border-radius: 4px;">
                  <strong>Shared from:</strong>
                  <p style="margin: 8px 0;">{{ post.shared_from.content }}</p>
                  <span style="font-size: 14px; color: #666;">by {{ post.shared_from.author.username }}</span>
                </div>
              {% endif %}
              
              {% if post.shared_restaurant_place_id %}
              <div class="shared-restaurant-info" style="background-color: #eef; border: 1px dashed #ccc; padding: 5px; margin: 10px 20px; border-radius: 4px;">
                <strong>Restaurant:</strong>
                <a href="{% url 'restaurant_detail' post.shared_restaurant_place_id %}"
                  style="text-decoration: none; color: #333; font-weight: bold;">
                  {{ post.shared_restaurant_name }}
                </a>
                <p style="font-size: 14px; color: #666; margin-top: 2px;">
                  Location: <strong>{{ post.shared_restaurant_city }}</strong>
                </p>
              </div>
            {% endif %}

            {% if post.shared_cuisine %}
              <div class="shared-cuisine-info" style="background-color: #eef; border: 1px dashed #ccc; padding: 10px; margin: 10px 20px; border-radius: 4px;">
                <strong>Cuisine:</strong>
                <a href="{% url 'recipe_detail' %}?dish={{ post.shared_cuisine }}"
                  style="text-decoration: none; color: #333; font-weight: bold;">
                  {{ post.shared_cuisine }}
                </a>
              </div>
            {% endif %}

              
              <div class="post-actions" style="display: flex; align-items: center; padding: 0 20px 16px; gap: 20px; border-bottom: 1px solid #f5f5f5; ">
                <div style="display: flex; align-items: center; gap: 6px; margin-top: 10px;">
                  <button class="like-btn" data-post-id="{{ post.id }}" onclick="toggleLike(this)" 
                    style=" background: none; border: none; font-size: 20px; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; padding: 0;">
                    {% if request.user in post.likes.all %}
                      ‚ù§Ô∏è
                    {% else %}
                      ü§ç
                    {% endif %}
                  </button>
                  <span class="like-count" style="font-size: 14px; color: #666;">{{ post.total_likes }} Likes</span>
                </div>
                
                <span class="comment-count" onclick="toggleComments(this)" style="cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 14px; color: #666; margin-top: 10px;">
                  <span style="font-size: 18px;">üí¨</span><span class="toggle-text"></span> {{ post.comments.count }} Comments
                </span>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <a href="{% url 'share_post' post.id %}" style="text-decoration: none; font-size: 20px; color: #666; margin-top: 10px;">üîó</a>
                  <span class="share-count" style="font-size:14px; color:#666; margin-top: 10px;">{{ post.shares.count }} Shares</span>
                </div>
                {% if post.author == request.user %}
                  <button onclick="deletePost(this)" class="btn-delete" style="margin-left: auto; background: none; border: none; color: #ff5252; font-size: 14px; display: flex; align-items: center; gap: 4px; cursor: pointer; margin-top: 10px;">
                    <span style="font-size: 18px;">üóëÔ∏è</span> Delete
                  </button>
                {% endif %}
              </div>
              
              <!-- comment list -->
              <div class="comments" data-post-id="{{ post.id }}" style="padding: 0 20px; display: none; background-color: #fcfcfc;">
                {% for comment in post.comments.all %}
                <div class="comment"
                id="comment-{{ comment.id }}"
                data-post-id="{{ post.id }}"
                style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #f0f0f0;">
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                      <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #f0f8ff; display: flex; align-items: center; justify-content: center; font-size: 14px;">üë§</div>
                      <div>
                        <div style="font-weight: 600; font-size: 14px; color: #333;">{{ comment.author.username }}</div>
                        <div style="font-size: 14px; color: #333; margin-top: 4px;">{{ comment.content }}</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">{{ comment.created_at|date:'M d, Y H:i' }}</div>
                      </div>
                    </div>
                    {% if request.user == comment.author or request.user == post.author %}
                      <button class="btn btn-link" onclick="deleteComment(this, parseInt('{{ comment.id }}', 10))" style="color: #ff5252; font-size: 12px; margin-left: auto;">
                        Delete
                      </button>
                    {% endif %}
                  </div>
                {% empty %}
                  <div class="no-comments-yet" style="padding: 20px 0; text-align: center; color: #999;">No comments yet. Be the first to comment!</div>
                {% endfor %}
              </div>

              <!-- submit comment use ajax -->
              <form class="comment-form" data-post-id="{{ post.id }}" onsubmit="addComment(event, this)" 
                style="display: flex; padding: 16px 20px; gap: 10px; background-color: #fcfcfc; border-top: 1px solid #f0f0f0;">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Add a comment..." 
                  style="flex: 1; padding: 10px 14px; border: 1px solid #e1e4e8; border-radius: 20px; font-size: 14px; outline: none; transition: border 0.2s;">
                <button type="submit" 
                  style="background-color: #a4dda6; color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: background-color 0.2s;">
                  Comment
                </button>
              </form>
            </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; margin-bottom: 20px;">
          <div class="sidebar-title">Your Profile</div>
          <div style="display: flex; margin-bottom: 15px;">
            
            <div class="post-avatar" style="width: 68px; height: 68px; border-radius: 50%; overflow: hidden; margin-right: 12px;">
              {% if user.profile.profile_image %}
                <img src="{{ user.profile.profile_image.url }}" alt="Profile Image" style="width:100%; height:100%; object-fit: cover;">
              {% else %}
                üë§
              {% endif %}
            </div>
            <div>
              <div style="font-size: 16px; font-weight: bold; margin-top: 5px">@{{ user.username }}</div>
              <div style="font-size: 14px; color: #666; margin-top: 5px">{{ user.email }}</div>
              <div style="font-size: 14px; margin-top: 5px;">{{ user.profile.bio|default:"No Intro" }}</div>
            </div>
          </div>
          <div style="display: flex; gap: 15px; margin-bottom: 15px; justify-content: space-evenly;">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-weight: bold;">{{ user.post_set.count }}</div>
              <div style="font-size: 15px; color: #666;">Posts</div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-weight: bold;">{{ user.profile.followers.count }}</div>
              <div style="font-size: 15px; color: #666;">Followers</div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="font-weight: bold;">{{ user.following_profiles.count }}</div>
              <div style="font-size: 15px; color: #666;">Following</div>
            </div>
          </div>
        <div style="text-align: center;">
          <a href="{% url 'profile' %}"><button class="btn btn-secondary" style="width: 50%;">Edit Profile</button></a>
        </div>
        </div>
        
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; margin-bottom: 20px;">
          <div class="sidebar-title">Trending Topics</div>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
            {% for tag in trending_tags %}
              <div class="filter-chip">#{{ tag }}</div>
            {% endfor %}
          </div>
        </div>
        
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px;">
          <div class="sidebar-title">Suggested For You</div>
          {% if suggested_users %}
            {% for suggested in suggested_users %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="display: flex; align-items: center;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #f0f0f0; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                  {% if suggested.profile_image %}
                    <img src="{{ suggested.profile_image.url }}" alt="Profile Image" style="width: 100%; height: 100%;object-fit: cover; border-radius: 50%;">
                  {% else %}
                    üë§
                  {% endif %}
                </div>
                <div>
                  <div style="font-weight: bold;">{{ suggested.user.username }}</div>
                  <div style="font-size: 12px; color: #666;">@{{ suggested.user.username }}</div>
                </div>
              </div>
              <button class="btn btn-secondary follow-btn" data-profile-id="{{ suggested.id }}" onclick="toggleFollow(this)">
                {% if request.user in suggested.followers.all %}
                  Unfollow
                {% else %}
                  Follow
                {% endif %}
              </button>
            </div>
            {% endfor %}
          {% else %}
            <div>No suggested users available.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript  -->
<script>
  const csrftoken = "{{ csrf_token }}";
  
  function toggleLike(buttonElement) {
    const postId = buttonElement.dataset.postId;
    fetch(`/ajax/like/${postId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        buttonElement.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
        const likeCountSpan = buttonElement.parentElement.querySelector('.like-count');
        likeCountSpan.textContent = data.likes_count + ' Likes';
      } else {
        alert('Error toggling like: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }
  
  function addComment(event, formElement) {
  event.preventDefault();
  const postId = formElement.dataset.postId;
  const contentInput = formElement.querySelector('input[name="content"]');
  const contentValue = contentInput.value.trim();

  fetch(`/ajax/comment/${postId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({ 'content': contentValue })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      contentInput.value = '';
      const postElement = formElement.closest('.post');
      const commentCountSpan = postElement.querySelector('.comment-count');
      const commentsContainer = postElement.querySelector('.comments');

      // Do NOT force display = 'block'; so if it was hidden, it stays hidden

      // Preserve the icon and toggle text
      const toggleTextSpan = commentCountSpan.querySelector('.toggle-text');
      let currentToggleText = '';
      if (toggleTextSpan) {
        currentToggleText = toggleTextSpan.textContent;
      }
      commentCountSpan.innerHTML = `<span style="font-size: 18px;">üí¨</span><span class="toggle-text">${currentToggleText}</span> ${data.comments_count} Comments`;

      // Remove 'no comments yet' element if present
      const noCommentsEl = commentsContainer.querySelector('.no-comments-yet');
      if (noCommentsEl) {
        noCommentsEl.remove();
      }

      // Build delete button if can_delete == true
      let deleteButtonHtml = '';
      if (data.can_delete) {
        deleteButtonHtml = `
          <button class="btn btn-link" onclick="deleteComment(this, ${data.comment_id})"
                  style="color: #ff5252; font-size: 12px; margin-left: auto;">
            Delete
          </button>`;
      }

      // Append new comment DOM
      const newCommentDiv = document.createElement('div');
      newCommentDiv.innerHTML = `
        <div class="comment" id="comment-${data.comment_id}" data-post-id="${postId}"
             style="display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #f0f0f0;">
          <div style="display: flex; gap: 8px; align-items: flex-start;">
            <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #f0f8ff;
                        display: flex; align-items: center; justify-content: center; font-size: 14px;">üë§</div>
            <div>
              <div style="font-weight: 600; font-size: 14px; color: #333;">${data.author}</div>
              <div style="font-size: 14px; color: #333; margin-top: 4px;">${data.content}</div>
              <div style="font-size: 12px; color: #999; margin-top: 4px;">${data.created_at}</div>
            </div>
          </div>
          ${deleteButtonHtml}
        </div>
      `;
      commentsContainer.appendChild(newCommentDiv.firstElementChild);

    } else {
      alert('Error adding comment: ' + data.error);
    }
  })
  .catch(error => console.error('Error:', error));
}

  function toggleComments(triggerElement) {
  const postElement = triggerElement.closest('.post');
  const commentsSection = postElement.querySelector('.comments');
  const toggleText = triggerElement.querySelector('.toggle-text');
  if (!commentsSection.style.display || commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    if (toggleText) {
      toggleText.textContent = ' Hide';
    }
  } else {
    commentsSection.style.display = 'none';
    if (toggleText) {
      toggleText.textContent = '';
    }
  }
}
  
  function deletePost(buttonElement) {
  if (!confirm("Are you sure you want to delete this post?")) return;
  const postElement = buttonElement.closest('.post');
  const postId = postElement.dataset.postId;

  fetch(`/posts/${postId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      postElement.remove();
    } else {
      alert(data.error || 'Delete failed.');
    }
  });
}

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function toggleFollow(buttonElement) {
    const profileId = buttonElement.dataset.profileId;
    fetch(`/ajax/follow/${profileId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        buttonElement.textContent = data.is_following ? 'Unfollow' : 'Follow';

        if (data.is_following) {
          buttonElement.style.backgroundColor = '#f0f0f0';
          buttonElement.style.color = '#333';
        } else {
          buttonElement.style.backgroundColor = '#4CAF50';
          buttonElement.style.color = 'white';
        }
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function deleteComment(buttonElement, commentId) {
  if (!confirm("Are you sure you want to delete this comment?")) return;

  fetch(`/ajax/comment/${commentId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/x-www-form-urlencoded'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const commentDiv = document.getElementById(`comment-${commentId}`);
      if (commentDiv) {
        commentDiv.remove();
        const postIdVal = commentDiv.dataset.postId; 
        // Now find post container by #post-xxx
        const postElement = document.getElementById(`post-${postIdVal}`);
        if (postElement) {
          const commentCountSpan = postElement.querySelector('.comment-count');
          if (commentCountSpan) {
            const toggleTextSpan = commentCountSpan.querySelector('.toggle-text');
            let currentToggleText = '';
            if (toggleTextSpan) {
              currentToggleText = toggleTextSpan.textContent;
            }
            commentCountSpan.innerHTML = `
              <span style="font-size: 18px;">üí¨</span>
              <span class="toggle-text">${currentToggleText}</span>
              ${data.comments_count} Comments
            `;
          } else {
            console.warn("No .comment-count found in post container.");
          }
        } else {
          console.warn(`No post container with id="post-${postIdVal}" found.`);
        }
      } else {
        console.warn(`Could not find comment-${commentId} in the DOM`);
      }
    } else {
      alert('Error deleting comment: ' + data.error);
    }
  })
  .catch(error => console.error('Error deleting comment:', error));
}
</script>
<!-- Slider functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.image-slider').forEach(function(slider) {
    const wrapper = slider.querySelector('.slider-wrapper');
    const images = slider.querySelectorAll('.slider-image');
    const prevButton = slider.querySelector('.slider-prev');
    const nextButton = slider.querySelector('.slider-next');
    let currentIndex = 0;


    function updateSlider() {
      if (images.length > 0) {
        const singleImgWidth = images[0].clientWidth; 
        const offset = -currentIndex * singleImgWidth;
        wrapper.style.transform = `translateX(${offset}px)`;
      }
    }

    images.forEach(img => {
      img.addEventListener('load', updateSlider);
    });


    updateSlider();

    if (images.length <= 1 && prevButton && nextButton) {
      prevButton.style.display = 'none';
      nextButton.style.display = 'none';
    } else if (prevButton && nextButton) {
      slider.addEventListener('mouseenter', function() {
        prevButton.style.display = 'block';
        nextButton.style.display = 'block';
      });
      slider.addEventListener('mouseleave', function() {
        prevButton.style.display = 'none';
        nextButton.style.display = 'none';
      });

      prevButton.addEventListener('click', function() {
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        updateSlider();
      });

      nextButton.addEventListener('click', function() {
        currentIndex = (currentIndex + 1) % images.length;
        updateSlider();
      });
    }

    window.addEventListener('resize', updateSlider);
  });
});
</script>
{% endblock %}