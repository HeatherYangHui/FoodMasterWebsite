{% extends 'foodmaster/base.html' %}

{% block title %}Food Master - Social Feed{% endblock %}

{% block content %}
<div class="wireframe-section">

    <div class="split-content">
      <div class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3>Food Community</h3>
          <a href="{% url 'create_post' %}"><button class="btn btn-primary">Create Post</button></a>
        </div>
        
        <div class="filters" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
          <div class="filter-chip" style="background-color: #f0f8ff; border: 1px solid #e1e4e8; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">Following</div>
          <div class="filter-chip" style="background-color: #4CAF50; color: white; border: 1px solid #4CAF50; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">Trending</div>
          <div class="filter-chip" style="background-color: #f0f8ff; border: 1px solid #e1e4e8; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">Breakfast</div>
          <div class="filter-chip" style="background-color: #f0f8ff; border: 1px solid #e1e4e8; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">Lunch</div>
          <div class="filter-chip" style="background-color: #f0f8ff; border: 1px solid #e1e4e8; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">Dinner</div>
          <div class="filter-chip" style="background-color: #f0f8ff; border: 1px solid #e1e4e8; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">Dessert</div>
        </div>
        
        <div class="social-feed">
          {% if posts %}
            {% for post in posts %}
            <div class="post" id="post-{{ post.id }}" data-post-id="{{ post.id }}" style="background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; overflow: hidden; transition: transform 0.2s; border: 1px solid #f0f0f0;">
              <div class="post-header" style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #f5f5f5;">
                <div class="post-avatar" style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; margin-right: 12px;">
                  {% if post.author.profile.profile_image %}
                    <img src="{{ post.author.profile.profile_image.url }}" alt="Profile Image" style="width: 100%; height: 100%; object-fit: cover;">
                  {% else %}
                    üë§
                  {% endif %}
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 16px; color: #333;">{{ post.author }}</div>
                  <div style="font-size: 14px; color: #666;">{{ post.time_ago }} ‚Ä¢ {{ post.category }}</div>
                </div>
                {% if request.user != post.author %}
                  {% if request.user in post.author.profile.followers.all %}
                    <button class="follow-btn following" data-profile-id="{{ post.author.profile.id }}" onclick="toggleFollow(this)" 
                      style="background-color: #f0f0f0; color: #333; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                      Unfollow
                    </button>
                  {% else %}
                    <button class="follow-btn" data-profile-id="{{ post.author.profile.id }}" onclick="toggleFollow(this)" 
                      style="background-color: #4CAF50; color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                      Follow
                    </button>
                  {% endif %}
                {% endif %}
              </div>
              
              {% if post.photo %}
              <div class="post-image" style="width: 100%; height: auto; max-height: 450px; overflow: hidden; position: relative; background-color: #f9f9f9;">
                <img src="{{ post.photo.url }}" loading="lazy" alt="Post Photo" style="width: 100%; height: auto; object-fit: contain;">
              </div>
              {% endif %}
              
              <div style="padding: 20px;">
                <p style="font-size: 16px; line-height: 1.5; color: #333; margin: 0;">{{ post.content }}</p>
                {% if post.tags %}
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px;">
                  {% for tag in post.tags %}
                  <span style="background-color: #f0fff0; color: #4CAF50; border-radius: 4px; padding: 4px 8px; font-size: 13px; font-weight: 500;">#{{ tag }}</span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              
              {% if post.shared_from %}
                <div class="shared-info" style="background-color: #f9f9f9; border: 1px dashed #ccc; padding: 10px; margin: 10px 20px; border-radius: 4px;">
                  <strong>Shared from:</strong>
                  <p style="margin: 8px 0;">{{ post.shared_from.content }}</p>
                  <span style="font-size: 14px; color: #666;">by {{ post.shared_from.author.username }}</span>
                </div>
              {% endif %}
              
              <div class="post-actions" style="display: flex; align-items: center; padding: 0 20px 16px; gap: 20px; border-bottom: 1px solid #f5f5f5;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <button class="like-btn" data-post-id="{{ post.id }}" onclick="toggleLike(this)" 
                    style="background: none; border: none; font-size: 20px; cursor: pointer; transition: transform 0.2s; display: flex; align-items: center; padding: 0;">
                    {% if request.user in post.likes.all %}
                      ‚ù§Ô∏è
                    {% else %}
                      ü§ç
                    {% endif %}
                  </button>
                  <span class="like-count" style="font-size: 14px; color: #666;">{{ post.total_likes }} Likes</span>
                </div>
                
                <span class="comment-count" onclick="toggleComments(this)" style="cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 14px; color: #666;">
                  <span style="font-size: 18px;">üí¨</span><span class="toggle-text"></span> {{ post.comments.count }} Comments
                </span>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <a href="{% url 'share_post' post.id %}" style="text-decoration: none; font-size: 20px; color: #666;">üîó</a>
                  <span class="share-count" style="font-size:14px; color:#666;">{{ post.shares.count }} Shares</span>
                </div>
                {% if post.author == request.user %}
                  <button onclick="deletePost(this)" class="btn-delete" style="margin-left: auto; background: none; border: none; color: #ff5252; font-size: 14px; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <span style="font-size: 18px;">üóëÔ∏è</span> Delete
                  </button>
                {% endif %}
              </div>
              
              <!-- comment list -->
              <div class="comments" data-post-id="{{ post.id }}" style="padding: 0 20px; display: none; background-color: #fcfcfc;">
                {% for comment in post.comments.all %}
                  <div class="comment" style="padding: 16px 0; border-bottom: 1px solid #f0f0f0;">
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                      <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #f0f8ff; display: flex; align-items: center; justify-content: center; font-size: 14px;">üë§</div>
                      <div>
                        <div style="font-weight: 600; font-size: 14px; color: #333;">{{ comment.author.username }}</div>
                        <div style="font-size: 14px; color: #333; margin-top: 4px;">{{ comment.content }}</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">{{ comment.created_at|date:'M d, Y H:i' }}</div>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div style="padding: 20px 0; text-align: center; color: #999;">No comments yet. Be the first to comment!</div>
                {% endfor %}
              </div>

              <!-- submit comment use ajax -->
              <form class="comment-form" data-post-id="{{ post.id }}" onsubmit="addComment(event, this)" 
                style="display: flex; padding: 16px 20px; gap: 10px; background-color: #fcfcfc; border-top: 1px solid #f0f0f0;">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Add a comment..." 
                  style="flex: 1; padding: 10px 14px; border: 1px solid #e1e4e8; border-radius: 20px; font-size: 14px; outline: none; transition: border 0.2s;">
                <button type="submit" 
                  style="background-color: #a4dda6; color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: background-color 0.2s;">
                  Comment
                </button>
              </form>
            </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; margin-bottom: 20px;">
          <h4>Your Profile</h4>
          <div style="display: flex; margin-bottom: 15px;">
            
            <div class="post-avatar" style="width: 48px; height: 48px; border-radius: 50%; overflow: hidden; margin-right: 12px;">
              {% if user.profile.profile_image %}
                <img src="{{ user.profile.profile_image.url }}" alt="Profile Image" style="width:100%; height:100%; object-fit: cover;">
              {% else %}
                üë§
              {% endif %}
            </div>
            <div>
              <div style="font-weight: bold;">{{ user.username }}</div>
              <div style="font-size: 14px; color: #666;">@{{ user.username }}</div>
              <div style="font-size: 14px; margin-top: 5px;">{{ user.profile.bio|default:"Food enthusiast & home cook" }}</div>
            </div>
          </div>
          <div style="display: flex; gap: 15px; margin-bottom: 15px;">
            <div>
              <div style="font-weight: bold;">{{ user.post_set.count }}</div>
              <div style="font-size: 12px; color: #666;">Posts</div>
            </div>
            <div>
              <div style="font-weight: bold;">{{ user.profile.followers.count }}</div>
              <div style="font-size: 12px; color: #666;">Followers</div>
            </div>
            <div>
              <div style="font-weight: bold;">{{ user.following_profiles.count }}</div>
              <div style="font-size: 12px; color: #666;">Following</div>
            </div>
          </div>
          <a href="{% url 'profile' %}"><button class="btn btn-secondary" style="width: 100%;">Edit Profile</button></a>
        </div>
        
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px; margin-bottom: 20px;">
          <h4>Trending Topics</h4>
          <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
            <div class="filter-chip">#ItalianFood</div>
            <div class="filter-chip">#HomeCooking</div>
            <div class="filter-chip">#Desserts</div>
            <div class="filter-chip">#HealthyEating</div>
            <div class="filter-chip">#Breakfast</div>
            <div class="filter-chip">#FoodPhotography</div>
          </div>
        </div>
        
        <div style="background-color: white; border-radius: 8px; border: 1px solid #eee; padding: 15px;">
          <h4>Suggested Users</h4>
          {% if suggested_users %}
            {% for suggested in suggested_users %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="display: flex; align-items: center;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: #f0f0f0; margin-right: 10px; display: flex; align-items: center; justify-content: center;">
                  {% if suggested.profile_image %}
                    <img src="{{ suggested.profile_image.url }}" alt="Profile Image" style="width: 100%; height: 100%; border-radius: 50%;">
                  {% else %}
                    üë§
                  {% endif %}
                </div>
                <div>
                  <div style="font-weight: bold;">{{ suggested.user.username }}</div>
                  <div style="font-size: 12px; color: #666;">@{{ suggested.user.username }}</div>
                </div>
              </div>
              <button class="btn btn-secondary follow-btn" data-profile-id="{{ suggested.id }}" onclick="toggleFollow(this)">
                {% if request.user in suggested.followers.all %}
                  Unfollow
                {% else %}
                  Follow
                {% endif %}
              </button>
            </div>
            {% endfor %}
          {% else %}
            <div>No suggested users available.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript ‰øùÊåÅ‰∏çÂèò -->
<script>
  const csrftoken = "{{ csrf_token }}";
  
  function toggleLike(buttonElement) {
    const postId = buttonElement.dataset.postId;
    fetch(`/ajax/like/${postId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        buttonElement.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
        const likeCountSpan = buttonElement.parentElement.querySelector('.like-count');
        likeCountSpan.textContent = data.likes_count + ' Likes';
      } else {
        alert('Error toggling like: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }
  
  function addComment(event, formElement) {
  event.preventDefault();
  const postId = formElement.dataset.postId;
  const contentInput = formElement.querySelector('input[name="content"]');
  const contentValue = contentInput.value;

  fetch(`/ajax/comment/${postId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({ 'content': contentValue })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Clear input
      contentInput.value = '';
      // Find comment-count and comments container in the same post
      const postElement = formElement.closest('.post');
      const commentCountSpan = postElement.querySelector('.comment-count');
      const commentsContainer = postElement.querySelector('.comments');

      // Update comment count
      commentCountSpan.textContent = data.comments_count + ' Comments';

      // Append new comment
      const newCommentDiv = document.createElement('div');
      newCommentDiv.innerHTML = `
        <div class="comment" style="padding: 16px 0; border-bottom: 1px solid #f0f0f0;">
          <div style="display: flex; gap: 8px; align-items: flex-start;">
            <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #f0f8ff; display: flex; align-items: center; justify-content: center; font-size: 14px;">üë§</div>
            <div>
              <div style="font-weight: 600; font-size: 14px; color: #333;">${data.author}</div>
              <div style="font-size: 14px; color: #333; margin-top: 4px;">${data.content}</div>
              <div style="font-size: 12px; color: #999; margin-top: 4px;">${data.created_at}</div>
            </div>
          </div>
        </div>
      `;
      commentsContainer.appendChild(newCommentDiv.firstElementChild);
    } else {
      alert('Error adding comment: ' + data.error);
    }
  })
  .catch(error => console.error('Error:', error));
}

  function toggleComments(triggerElement) {
  const postElement = triggerElement.closest('.post');
  const commentsSection = postElement.querySelector('.comments');
  const toggleText = triggerElement.querySelector('.toggle-text');
  if (!commentsSection.style.display || commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    if (toggleText) {
      toggleText.textContent = ' Hide';
    }
  } else {
    commentsSection.style.display = 'none';
    if (toggleText) {
      toggleText.textContent = '';
    }
  }
}
  
  function deletePost(buttonElement) {
  if (!confirm("Are you sure you want to delete this post?")) return;
  const postElement = buttonElement.closest('.post');
  const postId = postElement.dataset.postId;

  fetch(`/posts/${postId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      postElement.remove();
    } else {
      alert(data.error || 'Delete failed.');
    }
  });
}

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function toggleFollow(buttonElement) {
    const profileId = buttonElement.dataset.profileId;
    fetch(`/ajax/follow/${profileId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        buttonElement.textContent = data.is_following ? 'Unfollow' : 'Follow';
        // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
        if (data.is_following) {
          buttonElement.style.backgroundColor = '#f0f0f0';
          buttonElement.style.color = '#333';
        } else {
          buttonElement.style.backgroundColor = '#4CAF50';
          buttonElement.style.color = 'white';
        }
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  }

</script>
{% endblock %}