{% extends 'foodmaster/base.html' %}

{% block title %}Food Master - {{ recipe.title|default:"Spaghetti Carbonara" }}{% endblock %}

{% block content %}
<div class="wireframe-section">
  <div class="recipe-detail" style="display: flex; gap: 80px; align-items: flex-start;">
    
    <!-- LEFT COLUMN: Recipe Image + Nearby Markets -->
    <div style="flex: 1;">
      <!-- Recipe Image -->
      <div class="recipe-image"
           style="
             width: 100%;
             height: 200px;
             background-color: #f0f0f0;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-bottom: 20px;
           ">
        {% if recipe.image %}
          <img src="{{ recipe.image }}" alt="{{ recipe.title }}" style="max-width: 100%; max-height: 100%;">
        {% else %}
          [Recipe Image]
        {% endif %}
      </div>
      
      <!-- Nearby Markets -->
      <div class="nearby-markets" style="margin-top: 20px;">
        <h3 style="margin-bottom: 15px;">Nearby Markets</h3>
        
        <!-- Filter Form: store_type dropdown -->
        <form method="get" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px; font-size: 16px;">
          <!-- Keep dish, lat, lng so we stay on the same page -->
          <input type="hidden" name="dish" value="{{ request.GET.dish }}">
          <input type="hidden" name="lat" value="{{ lat }}">
          <input type="hidden" name="lng" value="{{ lng }}">
          
          <label for="store_type" style="font-weight: bold;">Store Type:</label>
          <select
            id="store_type"
            name="store_type"
            onchange="this.form.submit()"
            style="
              padding: 6px;
              font-size: 16px;
              border-radius: 4px;
              border: 1px solid #ccc;
              outline: none;
              cursor: pointer;
            "
          >
            <option value="asian_store" {% if store_type == "asian_store" %}selected{% endif %}>Asian Store</option>
            <option value="food_store" {% if store_type == "food_store" %}selected{% endif %}>Food Store</option>
            <option value="grocery_store" {% if store_type == "grocery_store" %}selected{% endif %}>Grocery Store</option>
            <option value="supermarket" {% if store_type == "supermarket" %}selected{% endif %}>Supermarket</option>
          </select>
        </form>
        
        {% if markets and markets|length > 0 %}
          {% for market in markets %}
            <div class="market-card" style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                {% if market.photo_url %}
                  <img 
                    src="{{ market.photo_url }}" 
                    alt="{{ market.name.text }}" 
                    style="width: 110px; height: 110px; object-fit: cover; border-radius: 4px;"
                  >
                {% else %}
                  <div style="width: 110px; height: 110px; background: #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                    üõí
                  </div>
                {% endif %}
                
                <div>
                  <div style="font-weight: bold; font-size: 18px; margin-bottom: 4px;">
                    {{ market.name.text.text }}
                  </div>
                  <div style="font-size: 14px; color: #555; margin-bottom: 4px;">
                    {{ market.address }}
                  </div>
                  <div style="font-size: 14px;">
                    ‚≠ê {{ market.rating }} ({{ market.distance }})
                    <span style="margin-left: 8px; color: #4CAF50;">Open</span>
                  </div>
                  {% if market.types %}
                    <div style="margin-top: 5px;">
                      {% for t in market.types %}
                        <span class="tag" style="background: #eee; padding: 3px 6px; border-radius: 4px; margin-right: 5px; font-size: 12px;">
                          {{ t }}
                        </span>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p style="font-size: 14px; color: #666;">No nearby markets found.</p>
        {% endif %}
      </div>
    </div>
    
    <!-- RIGHT COLUMN: Recipe Content -->
    <div class="recipe-content" style="flex: 1;">
      <h2>{{ recipe.title|default:"Spaghetti Carbonara" }}</h2>
      <div style="margin-bottom: 20px;">
        <span>
          {% if recipe.cuisines %}
            {{ recipe.cuisines|join:", " }}
          {% else %}
            Italian
          {% endif %}
           ‚Ä¢ {{ recipe.readyInMinutes|default:"25" }} min ‚Ä¢ Easy ‚Ä¢
        </span>
        <!-- <span>‚≠ê {{ recipe.aggregateLikes|default:"4.8" }} ({{ recipe.reviews|default:"156" }} reviews)</span> -->
      </div>
      
      <div style="display: flex; gap: 10px; margin-bottom: 30px;">
        {% comment %} <button class="btn btn-primary">Add to Shopping List</button> {% endcomment %}
        <form action="{% url 'toggle_save_recipe' %}" method="post" id="save-recipe-form" style="display: inline;">
          {% csrf_token %}
          <input type="hidden" name="recipe_id" value="{{ recipe.id|default:'' }}">
          <input type="hidden" name="title" value="{{ recipe.title }}">
          <button type="submit" class="btn btn-save-recipe {% if is_recipe_saved %}saved{% endif %}" id="save-recipe-btn">
            {% if is_recipe_saved %}Saved Recipe{% else %}Save Recipe{% endif %}
          </button>
        </form>
        <button class="btn btn-secondary">Share</button>
      </div>
      
      <!-- Times (No Servings Adjustment) -->
      <div style="display: flex; gap: 20px; margin-bottom: 30px;">
        <div style="flex: 1; padding: 15px; background-color: #f9f9f9; border-radius: 8px; text-align: center;">
          <div style="font-weight: bold;">Prep Time</div>
          <div>{{ recipe.preparationMinutes|default:"10" }} min</div>
        </div>
        <div style="flex: 1; padding: 15px; background-color: #f9f9f9; border-radius: 8px; text-align: center;">
          <div style="font-weight: bold;">Cook Time</div>
          <div>{{ recipe.cookingMinutes|default:"15" }} min</div>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
        <!-- Use data-target to map each tab to its corresponding content container -->
        <div class="tab active" data-target="ingredients-content" style="cursor: pointer; font-weight: bold;">
          Ingredients
        </div>
        <div class="tab" data-target="instructions-content" style="cursor: pointer;">
          Instructions
        </div>
        <div class="tab" data-target="nutrition-content" style="cursor: pointer;">
          Nutrition
        </div>
        <!-- <div class="tab" data-target="reviews-content" style="cursor: pointer;">
          Reviews
        </div> -->
      </div>
      
      <!-- Tab Contents -->
      <!-- Ingredients -->
      <div id="ingredients-content" class="tab-content">
        <h3>Ingredients</h3>
        {% if recipe and recipe.displayIngredients %}
          {% for ingredient in recipe.displayIngredients %}
            <div class="ingredient-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <input type="checkbox" style="transform: scale(1.3);" />
              <span>{{ ingredient.original }}</span>
            </div>
          {% endfor %}
        {% else %}
          <p>No ingredient information available.</p>
        {% endif %}
        
        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;">Add All to Shopping List</button>
      </div>

      <!-- Instructions -->
      <!-- Hide by default (use inline style or a CSS class) -->
      <div id="instructions-content" class="tab-content" style="display: none;">
        <h3>Instructions</h3>
        {% if recipe.instructions %}
          <p>{{ recipe.instructions|safe }}</p>
        {% elif recipe.analyzedInstructions %}
          {% for step in recipe.analyzedInstructions.0.steps %}
            <p><strong>Step {{ step.number }}:</strong> {{ step.step }}</p>
          {% endfor %}
        {% else %}
          <p>No instructions available.</p>
        {% endif %}
      </div>
      
      <!-- Nutrition -->
      <div id="nutrition-content" class="tab-content" style="display: none;">
        <h3>Nutrition</h3>
        {% if recipe.nutrition and recipe.nutrition.nutrients %}
          <table class="table table-striped" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Nutrient</th>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Amount</th>
                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">% Daily Value</th>
              </tr>
            </thead>
            <tbody>
              {% for nutrient in recipe.nutrition.nutrients %}
                <tr>
                  <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ nutrient.name }}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #ddd;">{{ nutrient.amount }} {{ nutrient.unit }}</td>
                  <td style="padding: 8px; border-bottom: 1px solid #ddd;">
                    {% if nutrient.percentOfDailyNeeds %}
                      {{ nutrient.percentOfDailyNeeds }}%
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>No nutritional information available.</p>
        {% endif %}
      </div>
      <!-- <div id="nutrition-content" class="tab-content" style="display: none;">
        <h3>Nutrition</h3>
        {% if recipe.nutrition and recipe.nutrition.nutrients %}
          <ul>
            {% for nutrient in recipe.nutrition.nutrients %}
              <li>{{ nutrient.title }}: {{ nutrient.amount }} {{ nutrient.unit }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No nutritional information available.</p>
        {% endif %}
      </div> -->
      
      <!-- Reviews -->
      <!-- <div id="reviews-content" class="tab-content" style="display: none;">
        <h3>Reviews</h3>
        <p>No reviews available. Be the first to review this recipe!</p>
      </div>
       -->
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Remove active class from all tabs
        tabs.forEach(t => t.classList.remove('active'));
        // Hide all content sections
        contents.forEach(content => content.style.display = 'none');
        
        // Mark the clicked tab as active
        this.classList.add('active');
        
        // Show the corresponding content
        const targetId = this.getAttribute('data-target');
        const targetContent = document.getElementById(targetId);
        if (targetContent) {
          targetContent.style.display = 'block';
        }
      });
    });
  });


  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const saveRecipeForm = document.getElementById('save-recipe-form');
  saveRecipeForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(saveRecipeForm);
    fetch("{% url 'toggle_save_recipe' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      const btn = document.getElementById('save-recipe-btn');
      if (data.success) {
        if (data.state === 'saved') {
          btn.textContent = 'Saved Recipe';
          btn.classList.add('saved');
        } else {
          btn.textContent = 'Save Recipe';
          btn.classList.remove('saved');
        }
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => console.error('Error:', error));
  });
</script>
{% endblock %}
